<!DOCTYPE html>
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <title>3D Model</title>
    <style>
        html, body{
            background-color: #383838;
            overscroll-behavior: contain;
        }
        #canvas{
            position: fixed;
            transform: translate(-50%,-50%);
            left: 50vw;
            top: 50vh;
            width: min(100vw, 100vh);
        }
        #title{
            position: fixed;
            transform: translate(-50%,-50%);
            left: 50vw;
            top: 2.5vh;
            color: white;
            z-index: 100;
            font-size: 5em;
            font-weight: bold;
            word-break: keep-all;
        }
        #arrow_left{
            position: fixed;
            transform: translate(-50%,-50%);
            left: 10vw;
            top: 50vh;
            width: 10vw;
            cursor: pointer;

        }
        #arrow_right{
            position: fixed;
            transform: translate(-50%,-50%) rotate(180deg);
            right: 0vw;
            top: 50vh;
            width: 10vw;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <canvas id="canvas" width="1080" height="1080"></canvas>
    <img id="arrow_left" src="resource/arrow.png" onclick="before()">
    <img id="arrow_right" src="resource/arrow.png" onclick="next()">
    <p id="title">아이스크림</p>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.141.0/build/three.module.js",
                "GLTFLoader": "https://unpkg.com/three@0.141.0/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>
    <script>
        let needUpdate = false;
        let now_obj = 0
        // let model_name_list = ['아이스크림','커피잔','생수병','화분','고구마','손전등','도마','레몬','막대사탕','냥이 책','모기향','양말','선글라스']
        let model_list = [
            {
                name : "아이스크림",
                background: "#111111",
                location : "001_icecream"
            },{
                name : "커피잔",
                background: "#555555",
                location : "002_coffee"
            },{
                name : "생수병",
                background: "#111111",
                location : "003_waterBottle"
            },{
                name : "화분",
                background: "#111111",
                location : "005_pot"
            },{
                name : "고구마",
                background: "#111111",
                location : "006_sweetPotato"
            },{
                name : "손전등",
                background: "#111111",
                location : "007_light"
            },{
                name : "도마",
                background: "#111111",
                location : "008_woodPlane"
            },{
                name : "레몬",
                background: "#111111",
                location : "009_lemon"
            },{
                name : "막대사탕",
                background: "#111111",
                location : "010_stickCandy"
            },{
                name : "책이다냥",
                background: "#111111",
                location : "011_catBook"
            },{
                name : "모기향",
                background: "#111111",
                location : "012_mosquitoRepellent"
            },{
                name : "양말",
                background: "#111111",
                location : "013_socks"
            },{
                name : "선슬라스",
                background: "#111111",
                location : "014_sunglass"
            },
        ]
        
        function before(){
            if (now_obj - 1 < 0){
                now_obj = model_list.length - 1
            } else {
                now_obj -= 1
            }
            console.log(now_obj)
            needUpdate = true;
        }
        function next(){
            if (now_obj + 1 > model_list.length){
                now_obj = 0
            } else {
                now_obj += 1
            }
            console.log(now_obj)
            needUpdate = true;
        }
    </script>
    <script type="module">
        import {GLTFLoader} from 'GLTFLoader';
        import * as THREE from 'three';
        
        const title = document.querySelector('#canvas')
        let scene = new THREE.Scene();
        const canvas = document.querySelector('#canvas')
        let renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias : true,
            alpha : true,
        });
        renderer.setClearColor( 0x000000, 0 );
        renderer.outputEncoding = THREE.sRGBEncoding;

        let camera = new THREE.OrthographicCamera(-5, 5, 5, -5, -0.5, 1000);
        camera.position.set(0,0,10);

        let loader = new GLTFLoader();
        let object;

        loader.load('resource/3dModel/001_icecream.gltf', function (gltf) {
            object = gltf.scene;
            scene.add(object);
            renderer.render(scene, camera);
            
            let isDragging = false;
            let previousTouchEvent = null;
            
            function handleTouchStart(event) {
                isDragging = true;
                previousTouchEvent = event.touches[0];
            }

            function handleTouchEnd() {
                isDragging = false;
                previousTouchEvent = null;
            }

            function handleTouchMove(event) {
                if (!isDragging || !previousTouchEvent) return;

                let currentTouchEvent = event.touches[0];
                let deltaMoveX = currentTouchEvent.clientX - previousTouchEvent.clientX;
                let deltaMoveY = currentTouchEvent.clientY - previousTouchEvent.clientY;

                // 이전 터치 위치와 현재 터치 위치의 차이에 따라 오브젝트 회전
                object.rotation.y += deltaMoveX * 0.005;
                object.rotation.x += deltaMoveY * 0.005;

                renderer.render(scene, camera);

                previousTouchEvent = currentTouchEvent;
            }

            document.addEventListener('touchstart', handleTouchStart);
            document.addEventListener('touchend', handleTouchEnd);
            document.addEventListener('touchmove', handleTouchMove);

            function animate(){
                requestAnimationFrame(animate)
                if (!isDragging) {
                    // 터치 드래그 중이 아닐 때 회전
                    object.rotation.y -= 0.01;
                }

                if(needUpdate){
                    console.log(`오브젝트 업데이트, 경로:resource/3dModel/${model_list[now_obj].location}.gltf`);
                    loader.load(`resource/3dModel/${model_list[now_obj].location}.gltf`, function (gltf2){
                        scene = new THREE.Scene();
                        object = gltf2.scene;
                        scene.add(object);
                    });

                    needUpdate = false;
                }
                
                renderer.render(scene, camera);
            }
            animate();
        });
    </script>
</body>
</html>
